{% extends "base1.html" %}
{% load static %}

{% block title %}Book {{ service_name }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
/* Step indicator */
.steps {
    text-align: center;
    font-size: 1.2rem;
    margin: 1rem 0 2rem;
    font-weight: bold;
}

.steps .step.active {
    color: #7b2ff7;
}

.separator {
    margin: 0 1rem;
    color: #888;
}

.booking-wrapper {
    max-width: 900px;
    margin: auto;
}

.slide {
    display: none;
}

.slide.active {
    display: block;
}

.booking-container {
    padding: 2rem;
}

.booking-form {
    background: #f9f9f9;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.booking-form h2 {
    margin-bottom: 1.5rem;
    text-align: center;
}

.booking-form label {
    margin-top: 1rem;
    font-weight: 500;
}

.booking-form input,
.booking-form select,
.booking-form textarea {
    width: 100%;
    padding: 0.6rem;
    margin-top: 0.3rem;
    border-radius: 8px;
    border: 1px solid #ccc;
}
/* Confirmation Box */
.confirmation-box {
    text-align: center;
    padding: 3rem 2rem;
    background: linear-gradient(135deg, #7b2ff7, #00c6ff);
    color: #fff;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: fadeInUp 0.8s ease-out;
}

.confirmation-box h3 {
    font-size: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
}

.confirmation-box p {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 2rem;
}

.confirmation-box button {
    padding: 0.8rem 2rem;
    border: none;
    border-radius: 30px;
    background: #fff;
    color: #7b2ff7;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

.confirmation-box button:hover {
    background: #f1f1f1;
    transform: scale(1.05);
}

/* Animation */
@keyframes fadeInUp {
    0% { 
        opacity: 0; 
        transform: translateY(40px); 
    }
    100% { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.booking-form button {
    margin-top: 1.5rem;
    width: 100%;
    padding: 0.8rem;
    border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, #7b2ff7, #00c6ff);
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
}

.booking-form button:hover {
    opacity: 0.9;
}

.contact-row,
.address-row,
.card-row {
    display: flex;
    gap: 1rem;
}

.contact-field,
.address-field,
.card-field {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.square-ft-inputs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.popup-box {
    text-align: center;
    padding: 2rem;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

/* Price calculation display */
.price-display {
    background: #e8f5e9;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
}

.price-display .price {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2e7d32;
}

.design-popup {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
}

.design-popup-content {
  background: #fff;
  width: 80%;
  max-width: 900px;
  margin: 5% auto;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  max-height: 80vh;
  overflow-y: auto;
  position: relative; 
  z-index: 10000; 
}

.design-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(200px,1fr));
  gap: 15px;
  margin-top: 20px;
}

.design-card {
  background: #f9f9f9;
  padding: 10px;
  border-radius: 10px;
  text-align: center;
  cursor: pointer;
  transition: 0.3s;
}
.design-card img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 8px;
}
.design-card:hover {
  transform: scale(1.05);
  background: #eef;
}
.close-btn {
  float: right;
  font-size: 24px;
  cursor: pointer;
}
#clearDesignBtn {
  background: #ff4d4d;
  color: white;
  border: none;
  padding: 3px 8px;
  font-size: 0.7rem;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 8px;
  transition: 0.2s;
}
#clearDesignBtn:hover {
  background: #d93636;
}

/* Toast popup */
.toast {
  visibility: hidden;
  min-width: 250px;
  background: #333;
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  z-index: 10000;
  left: 50%;
  bottom: 30px;
  transform: translateX(-50%);
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.4s, bottom 0.4s;
}
.toast.show {
  visibility: visible;
  opacity: 1;
  bottom: 50px;
}
/* Step Indicator */
.steps {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 2rem 0 3rem;
  gap: 60px;
  position: relative;
}

.steps::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 15%;
  right: 15%;
  height: 4px;
  background:none;
  z-index: 1;
  border-radius: 2px;
}

.step {
  position: relative;
  text-align: center;
  font-size: 1rem;
  font-weight: 600;
  color: #888;
  z-index: 2;
  transition: 0.3s;
}

.step .circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 10px;
  font-weight: bold;
  font-size: 1.1rem;
  transition: 0.3s;
}

.step.active .circle {
  background: linear-gradient(135deg, #7b2ff7, #00c6ff);
  color: #fff;
  box-shadow: 0 0 12px rgba(123,47,247,0.5);
}

.step.active {
  color: #7b2ff7;
}

.step.completed .circle {
  background: #2ecc71;
  color: #fff;
}

.step.completed {
  color: #2ecc71;
}

.steps::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 15%;
  height: 4px;
  background: linear-gradient(135deg, #7b2ff7, #00c6ff);
  width: 0%;
  z-index: 1;
  border-radius: 2px;
  transition: width 0.5s ease-in-out;
}

</style>

<div class="booking-wrapper">

<div class="steps">
  <div class="step active" id="step1">
    <div class="circle">1</div>
    Booking
  </div>
</div>



    <div class="slide active" id="booking-slide">
        <div class="booking-container">
            <form class="booking-form" id="bookingForm" method="POST">
                {% csrf_token %}
                <h2>Book {{ service_name }}</h2>

                <label>Service</label>
                <input type="text" name="service_name" value="{{ service_name }}" readonly>

                <div class="contact-row">
                    <div class="contact-field">
                        <label>Contact Number</label>
                        <input type="text" name="contact_number" required>
                    </div>
                    <div class="contact-field">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                </div>

                <label>Address</label>
                <textarea name="address" required></textarea>

                <div class="address-row">
                    <div class="address-field">
                        <label>Pin Code</label>
                        <input type="text" name="pin_code" required>
                    </div>
                    <div class="address-field">
                        <label>State</label>
                        <input type="text" name="state" required>
                    </div>
                    <div class="address-field">
                        <label>City</label>
                        <input type="text" name="city" required>
                    </div>
                </div>
                <label>Choose Your Design</label>
<button type="button" class="design-btn" onclick="openDesignPopup()">Select Design</button>
<small><button type="button" id="clearDesignBtn" onclick="clearDesignSelection()" style="display:none;">✖ Clear Design</button></small>

<input type="hidden" name="selected_design_name" id="selected_design_name_input">
<input type="hidden" name="selected_design_price" id="selected_design_price_input">
<input type="hidden" name="selected_design_id" id="selected_design_id_input">

<div id="selected-design-info" class="address-row" style="display: none; margin-top: 1rem;">
  <div class="address-field">
      <label>Selected Design Name</label>
      <input type="text" id="design_name_display" readonly disabled>
  </div>
  <div class="address-field">
      <label>Design Price (₹)</label>
      <input type="text" id="design_price_display" readonly disabled>
  </div>
</div>

<label>Or Upload Your Own Design</label>
<input type="file" id="custom_design_input" name="custom_design" accept="image/*">


                <label>Total Walls</label>
                <input type="number" min="1" 
  step="1"  name="total_walls" required>

                <div class="square-appointment-row">
                    <div class="square-ft">
                        <label>Square Ft</label>
                        <div class="square-ft-inputs">
                            <input 
  type="number" 
  id="width" 
  name="width" 
  placeholder="Width" 
  min="5" 
  step="1" 
  oninput="validity.valid||(value='');" 
  required
>
<span>*</span>
<input 
  type="number" 
  id="height" 
  name="height" 
  placeholder="Height" 
  min="5" 
  step="1" 
  oninput="validity.valid||(value='');" 
  required
>
<span>=</span>

                            <input type="number" id="total_sqft" name="total_sqft" readonly>
                        </div>
                    </div>
                </div>

                <!-- Price Display -->
                <div class="price-display" id="price-display" style="display: none;">
                    <div>Estimated Price:</div>
                    <div class="price" id="calculated-price">₹0</div>
                    <small>(₹50 per sqft)</small>
                </div>

                <div class="appointment-date">
                    <label>Appointment Date</label>
                    <input type="date" id="appointment_date" name="appointment_date" required>
                </div>
                <input type="hidden" name="total_amount" id="total_amount_input">

                <button type="button" onclick="saveBooking()">Book Now</button>

            </form>
        </div>
    </div>

    <!-- PAYMENT SLIDE -->
     <!-- <div class="slide" id="payment-slide">
        <div class="booking-container">
            <form class="booking-form" id="paymentForm">
                {% csrf_token %}
                <h2>Payment</h2>

                <label>Payment Mode</label>
                <select name="payment_mode" id="payment_mode" required>
                    <option value="razorpay">Online Payment</option>
                    <option value="cash">Cash on Service</option>
                </select> -->
<label style="display:none;">Amount</label>
<input type="text" id="booking_amount" name="booking_amount" value="0" readonly style="display:none;">

                            <!-- <div id="cash-note-box" style="display:none; margin-top: 1rem;">
                <p style="color: red; font-weight: 600;">
                    💡 Note: At least 40% of the total amount must be paid now rest after service completion.
                </p>

                <label>Advance Payment (₹)</label>
                <input type="text" id="cash_advance" name="cash_advance" readonly>
            </div>

                <button type="button" onclick="initiatePayment()" id="payment-btn">
                    <span id="payment-btn-text">Proceed to Pay</span>
                    <span id="payment-loader" style="display:none;">Processing...</span>
                </button>
            </form>
        </div>
    </div>  -->

    <div class="slide" id="confirmation-slide">
  <div class="confirmation-box">
      <h3>🎉 Booking Confirmed!</h3>
      <p>
          Your booking for <strong>{{ service_name }}</strong> is successful.<br>
          ✅ Our team will get in touch with you within 24 hrs.
      </p>
      <button onclick="goHome()">Go to Home</button>
  </div>
</div>

</div>
<div id="designPopup" class="design-popup">
  <div class="design-popup-content">
    <span class="close-btn" onclick="closeDesignPopup()">&times;</span>
    <h3>Select a Design for {{ service_name }}</h3>
    <div class="design-gallery">
      {% for img in db_images %}
      <div class="design-card" onclick="selectDesign('{{ img.id }}','{{ img.image_name }}','{{ img.price }}')">
        <img src="{{ img.image.url }}" alt="{{ img.image_name }}">
        <h4>{{ img.image_name }}</h4>
        <p>₹{{ img.price }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>
<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll('.slide');
    
    function showSlide(index) {
        slides.forEach((s, i) => s.classList.toggle('active', i === index));
        currentSlide = index;
        document.getElementById("step1").classList.toggle("active", index === 0);
        // document.getElementById("step2").classList.toggle("active", index === 1);
    }

    const SERVICE_BASE_RATES = {
    "3D Art": 120, // ₹120 per sq ft
    "Normal Paint": 100, // ₹100 per sq ft
    "Mural": 800, // ₹800 per sq ft
    // Add other services here, with a sensible default if the service_name doesn't match
    "Default": 50 
};

// Auto sqft and price calculation
// const SERVICE_BASE_RATES = {
//     "3D Art": 120, // ₹120 per sq ft
//     "Normal Paint": 100, // ₹100 per sq ft
//     "Mural": 800, // ₹800 per sq ft
//     "Default": 50 // Default fallback rate
// };

// Auto sqft and price calculation listeners
document.getElementById("width").addEventListener("input", calcSqftAndPrice);
document.getElementById("height").addEventListener("input", calcSqftAndPrice);
document.querySelector('input[name="total_walls"]').addEventListener("input", calcSqftAndPrice);


function calcSqftAndPrice() {
    let w = parseFloat(document.getElementById("width").value) || 0;
    let h = parseFloat(document.getElementById("height").value) || 0;
    
    // Total Walls: Use 1 if the user hasn't entered a value yet
    let totalWalls = parseFloat(document.querySelector('input[name="total_walls"]').value) || 1; 

    // Calculate Square Footage of ONE wall
    let singleWallSqft = w * h;
    
    // Calculate the TOTAL Square Footage for the job (Area of all walls)
    let totalSqft = singleWallSqft * totalWalls;

    let totalPrice = 0;
    
    // Get the base service name
    const serviceName = document.querySelector('input[name="service_name"]').value.trim();

    // 1. Check for SELECTED DESIGN PRICE (Treat Design Price as the new Rate per Sq Ft)
    const designPriceInput = document.getElementById("selected_design_price_input");
    const selectedDesignPrice = parseFloat(designPriceInput.value) || 0;

    if (selectedDesignPrice > 0) {
        // --- FIX IMPLEMENTED HERE ---
        // Treat selectedDesignPrice as the special rate per sq ft for this design.
        // Calculation: Total Area * Design Price (Rate)
        totalPrice = totalSqft * selectedDesignPrice;
        
        // Update the price display small text
        document.querySelector('#price-display small').textContent = `(₹${selectedDesignPrice} per sqft - Special Design Rate)`;
        console.log(`Calculation (Design Rate): ${totalSqft.toFixed(2)} (Total SqFt) * ${selectedDesignPrice} (Rate) = ₹${totalPrice}`);

    } else {
        // 2. Use HARDCODED BASE RATE (Per Sq Ft Calculation for custom design/service)
        let baseRate = SERVICE_BASE_RATES[serviceName] || SERVICE_BASE_RATES["Default"];
        
        // Calculation: Total Area * Base Rate
        totalPrice = totalSqft * baseRate;
        
        // Update the price display small text
        document.querySelector('#price-display small').textContent = `(₹${baseRate} per sqft)`;
        console.log(`Calculation (Base Rate): ${totalSqft.toFixed(2)} (Total SqFt) * ${baseRate} (Rate) = ₹${totalPrice}`);
    }
    
    // Update square feet display (total area)
    document.getElementById("total_sqft").value = totalSqft.toFixed(2);
    
    // Update price display
    if (totalSqft > 0) {
        document.getElementById("price-display").style.display = "block";
        document.getElementById("calculated-price").textContent = "₹" + totalPrice.toFixed(2);
        document.getElementById("booking_amount").value = totalPrice.toFixed(2);
        document.getElementById("total_amount_input").value = totalPrice.toFixed(2);
    } else {
        document.getElementById("price-display").style.display = "none";
        document.getElementById("calculated-price").textContent = "₹0";
        document.getElementById("booking_amount").value = 0;
    }
}

    // Datepicker
    flatpickr("#appointment_date", {
        dateFormat: "d-m-Y",
        minDate: "today"
    });

    // Save Booking → Move to Payment
function saveBooking() {
    let amount = document.getElementById('booking_amount').value;
    if (!amount || parseFloat(amount) <= 0) {
        alert('Please enter width and height to calculate the price.');
        return;
    }

    let form = $('#bookingForm')[0];
    let formData = new FormData(form);

    $.ajax({
        url: '/home/save_booking/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(resp) {
            showSlide(1); // Go directly to confirmation
        },
        error: function() {
            alert("Something went wrong, but booking saved.");
            showSlide(1); // Still show confirmation
        }
    });
}

// // Handle payment mode change
// document.getElementById("payment_mode").addEventListener("change", function() {
//     const mode = this.value;
//     const totalAmount = parseFloat(document.getElementById("booking_amount").value) || 0;

//     if (mode === "cash") {
//         // Show note box
//         document.getElementById("cash-note-box").style.display = "block";

//         // Calculate 40%
//         let advance = (totalAmount * 0.40).toFixed(2);
//         document.getElementById("cash_advance").value = advance;

//     } else {
//         // Hide note box for Online payment
//         document.getElementById("cash-note-box").style.display = "none";
//         document.getElementById("cash_advance").value = "";
//     }
// });

//     // PAYMENT FUNCTIONS
//    function initiatePayment() {
//     const paymentMode = document.getElementById('payment_mode').value;
//     let amount = parseFloat(document.getElementById('booking_amount').value);

//     if (paymentMode === 'cash') {
//         // Take only 40% for Razorpay
//         const advance = parseFloat(document.getElementById('cash_advance').value);
//         if (!advance || advance <= 0) {
//             alert("Invalid advance amount calculation.");
//             return;
//         }
//         amount = advance; // override amount
//     }

//     if (paymentMode === 'cash') {
//         startRazorpayPayment(amount); // pay only advance
//     } else if (paymentMode === 'razorpay') {
//         startRazorpayPayment(amount); // pay full amount
//     }
// }

    // function startRazorpayPayment(amount) {
    // if (!amount || amount <= 0) {
    //     alert('Invalid amount. Please check the booking amount.');
    //     return;
    // }

    // showPaymentLoading(true);

//     $.ajax({
//         url: '/create_razorpay_order/',
//         type: 'POST',
//         data: {
//             'amount': amount, // send only advance if cash
//             'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
//         },
//         success: function(response) {
//             showPaymentLoading(false);
//             if (response.success) {
//                 openRazorpayCheckout(response);
//             } else {
//                 alert('Error creating payment order: ' + response.error);
//             }
//         },
//         error: function(xhr, status, error) {
//             showPaymentLoading(false);
//             alert('Something went wrong while creating payment order: ' + error);
//         }
//     });
// }


    // function openRazorpayCheckout(orderData) {
    //     // Get customer details from booking form
    //     const contactNumber = document.querySelector('input[name="contact_number"]').value;
    //     const email = document.querySelector('input[name="email"]').value;
    //     const customerName = "Customer";

    //     const options = {
    //         "key": orderData.key_id,
    //         "amount": orderData.amount,
    //         "currency": orderData.currency,
    //         "name": "Home Services", // Replace with your business name
    //         "description": "Service Booking Payment",
    //         "order_id": orderData.order_id,
    //         "handler": function (response) {
    //             verifyPayment(response);
    //         },
    //         "prefill": {
    //             "name": customerName,
    //             "email": email,
    //             "contact": contactNumber
    //         },
    //         "notes": {
    //             "service": "{{ service_name }}"
    //         },
    //         "theme": {
    //             "color": "#7b2ff7"
    //         },
    //         "modal": {
    //             "ondismiss": function(){
    //                 showPaymentLoading(false);
    //                 alert('Payment was cancelled');
    //             }
    //         }
    //     };
        
    //     const rzp = new Razorpay(options);
    //     rzp.open();
    // }

    // function verifyPayment(response) {
    //     showPaymentLoading(true);
        
    //     $.ajax({
    //         url: '/verify_razorpay_payment/',
    //         type: 'POST',
    //         contentType: 'application/json',
    //         data: JSON.stringify({
    //             'razorpay_order_id': response.razorpay_order_id,
    //             'razorpay_payment_id': response.razorpay_payment_id,
    //             'razorpay_signature': response.razorpay_signature
    //         }),
    //         headers: {
    //             "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
    //         },
    //         success: function(verifyResponse) {
    //             showPaymentLoading(false);
    //             if (verifyResponse.success) {
    //                 // Payment successful - go to confirmation
    //                 showSlide(2);
    //             } else {
    //                 alert('Payment verification failed: ' + verifyResponse.error);
    //             }
    //         },
    //         error: function() {
    //             showPaymentLoading(false);
    //             alert('Error verifying payment!');
    //         }
    //     });
    // }

    // function showPaymentLoading(show) {
    //     if (show) {
    //         document.getElementById('payment-btn-text').style.display = 'none';
    //         document.getElementById('payment-loader').style.display = 'inline';
    //         document.getElementById('payment-btn').disabled = true;
    //     } else {
    //         document.getElementById('payment-btn-text').style.display = 'inline';
    //         document.getElementById('payment-loader').style.display = 'none';
    //         document.getElementById('payment-btn').disabled = false;
    //     }
    // }

    function goHome() {
        window.location.href = "{% url 'home' %}";
    }



    function openDesignPopup() {
  document.getElementById("designPopup").style.display = "block";
}
function closeDesignPopup() {
  console.log("Close button clicked!"); 
  document.getElementById("designPopup").style.display = "none";
}
     /**
   * Updates the hidden form fields and visible display fields when a design is selected.
     * @param {string} id - The primary key/ID of the design.
     * @param {string} name - The name of the selected design.
     * @param {string} price - The price of the selected design.
     */
    function selectDesign(id, name, price) {
    // 1. Clear custom upload
    document.getElementById("custom_design_input").value = "";

    // 2. Update hidden fields
    document.getElementById("selected_design_id_input").value = id;
    document.getElementById("selected_design_name_input").value = name;
    document.getElementById("selected_design_price_input").value = price;

    // 3. Update visible fields
    document.getElementById("design_name_display").value = name;
    document.getElementById("design_price_display").value = price;
    document.getElementById("selected-design-info").style.display = 'flex';

    // 4. Show clear button
    document.getElementById("clearDesignBtn").style.display = "inline-block";

    // 5. Recalculate
    calcSqftAndPrice();

    // 6. Toast
    showToast("Design selected: " + name + " (₹" + price + ")");
    closeDesignPopup();
}
document.getElementById("custom_design_input").addEventListener("change", function() {
    if (this.files.length > 0) {
        clearDesignSelection();
        showToast("Custom design uploaded. Design selection cleared.");
    }
});


function clearDesignSelection() {
    // Clear hidden fields
    document.getElementById("selected_design_id_input").value = '';
    document.getElementById("selected_design_name_input").value = '';
    document.getElementById("selected_design_price_input").value = '0';

    // Hide and clear visible display
    document.getElementById("design_name_display").value = '';
    document.getElementById("design_price_display").value = '';
    document.getElementById("selected-design-info").style.display = 'none';

    // Hide clear button
    document.getElementById("clearDesignBtn").style.display = "none";

    // Recalculate with base rate
    calcSqftAndPrice();
}
function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => {
        toast.classList.remove("show");
    }, 2500);
}
</script>

{% endblock %}