{% extends "base1.html" %}
{% load static %}

{% block title %}Reviews & Feedback - RColourcraft{% endblock %}

{% block extra_head %}
  {% endblock %}

{% block content %}
  <section class="hero">
    <h1>What Our Customers Say</h1>
    <p>Your words inspire us. Your art tells the story.</p>
  </section>

  <section class="reviews-section">
    <h2>Customer Reviews</h2>
    <div class="reviews-grid" id="reviewsGrid">
      <div class="review-card">
        <img src="{% static 'gallery/john.jpg' %}" alt="John D">
        <div class="review-content">
          <h3>John D. <span class="stars">⭐ ⭐ ⭐ ⭐ ⭐</span></h3>
          <p>"Amazing wall art! Totally transformed my living room."</p>
        </div>
      </div>
      <div class="review-card">
        <img src="{% static 'gallery/rohit.jpg' %}" alt="Rohit">
        <div class="review-content">
          <h3>Emily R. <span class="stars">⭐ ⭐ ⭐ ⭐</span></h3>
          <p>"The 3D painting is stunning, it feels alive!"</p>
        </div>
      </div>
      <div class="review-card">
        <img src="{% static 'gallery/rahul.jpg' %}" alt="Rahul S">
        <div class="review-content">
          <h3>Rahul S. <span class="stars">⭐ ⭐ ⭐ ⭐ ⭐</span></h3>
          <p>"Very professional team, highly recommended."</p>
        </div>
      </div>
      {% for r in reviews %}
        <div class="review-card">
          {% if r.review_image %}
            <img src="{{ r.review_image.url }}" alt="{{ r.customer_name }}">
          {% else %}
            <img src="{% static 'gallery/default-user.png' %}" alt="User">
          {% endif %}
          <div class="review-content">
            <h3>{{ r.customer_name }}
              <span class="stars">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= r.rating %}
                    ⭐
                  {% else %}
                    ☆
                  {% endif %}
                {% endfor %}
              </span>
            </h3>
            <p>"{{ r.customer_review }}"</p>
          </div>
        </div>
      {% empty %}
        {% endfor %}
    </div>
  </section>

  <section class="gallery-section">
    <div class="review-form">
      <h3>Leave a Review</h3>
      <form id="reviewForm" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <input type="text" name="name" placeholder="Your Name" required>
        <input type="email" name="email" placeholder="Your Email" required>
        <textarea name="customaer_review" rows="4" placeholder="Your Review"></textarea>

        <label>Your Rating:</label>
        <div class="star-rating">
          <input class="star star-5" id="star-5" type="radio" name="rating" value="5"/>
          <label class="star star-5" for="star-5"></label>
          <input class="star star-4" id="star-4" type="radio" name="rating" value="4"/>
          <label class="star star-4" for="star-4"></label>
          <input class="star star-3" id="star-3" type="radio" name="rating" value="3"/>
          <label class="star star-3" for="star-3"></label>
          <input class="star star-2" id="star-2" type="radio" name="rating" value="2"/>
          <label class="star star-2" for="star-2"></label>
          <input class="star star-1" id="star-1" type="radio" name="rating" value="1"/>
          <label class="star star-1" for="star-1"></label>
        </div>

        <div class="form-group">
          <label for="image">Upload your picture (optional):</label>
          <div class="custom-file-input-container">
            <label for="image" class="custom-file-label">Choose File</label>
            <span id="file-name-display" class="file-name-text">No file chosen</span>
            <input type="file" name="image" id="image" class="custom-file-input">
          </div>
        </div>

        <div class="form-group text-center">
          <button type="submit">Submit Review</button>
        </div>
      </form>

      <div id="response" style="margin-top:12px"></div>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    (function(){
      const form = document.getElementById('reviewForm');
      const responseDiv = document.getElementById('response');
      const reviewsGrid = document.getElementById('reviewsGrid');
      const defaultImage = "{% static 'gallery/default-user.png' %}";

      form.addEventListener('submit', function(e){
        e.preventDefault();
        responseDiv.innerHTML = "";

        const fd = new FormData(form);

        fetch("{% url 'save_review' %}", {
          method: "POST",
          body: fd,
        })
        .then(async res => {
          const json = await res.json().catch(()=>({success:false, error: 'Invalid JSON'}));
          if (!res.ok) throw json;
          return json;
        })
        .then(data => {
          if (data.success) {
            responseDiv.innerHTML = "<div style='color:green; margin-bottom:8px'>" + data.message + "</div>";
            const imgSrc = data.data.image ? data.data.image : defaultImage;
            const stars = '⭐'.repeat(Number(data.data.rating || 0));
            const reviewText = data.data.customaer_review ? data.data.customaer_review : "";
            const newCard = `
              <div class="review-card">
                <img src="${imgSrc}" alt="${data.data.name}">
                <div class="review-content">
                  <h3>${data.data.name} <span class="stars">${stars}</span></h3>
                  <p>"${reviewText}"</p>
                </div>
              </div>`;
            reviewsGrid.insertAdjacentHTML('afterbegin', newCard);
            form.reset();
          } else {
            if (data.errors) {
              let html = "<ul style='color:red; text-align:left; display:inline-block;'>";
              for (const k in data.errors) {
                html += `<li>${k}: ${data.errors[k].join(', ')}</li>`;
              }
              html += "</ul>";
              responseDiv.innerHTML = html;
            } else {
              responseDiv.innerHTML = "<div style='color:red'>"+(data.error||'Submission failed')+"</div>";
            }
          }
        })
        .catch(err => {
          console.error(err);
          const msg = (err && err.error) ? err.error : "Something went wrong. Check console.";
          responseDiv.innerHTML = "<div style='color:red'>" + msg + "</div>";
        });
      });

      // File input listener
      document.getElementById('image').addEventListener('change', function(e) {
        const fileName = e.target.files.length > 0 ? e.target.files[0].name : "No file chosen";
        document.getElementById('file-name-display').textContent = fileName;
      });
    })();
  </script>
{% endblock %}