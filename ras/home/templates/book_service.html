{% extends "base1.html" %}
{% load static %}

{% block title %}Book {{ service_name }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
/* Step indicator */
.steps {
    text-align: center;
    font-size: 1.2rem;
    margin: 1rem 0 2rem;
    font-weight: bold;
}

.steps .step.active {
    color: #7b2ff7;
}

.separator {
    margin: 0 1rem;
    color: #888;
}

.booking-wrapper {
    max-width: 900px;
    margin: auto;
}

.slide {
    display: none;
}

.slide.active {
    display: block;
}

.booking-container {
    padding: 2rem;
}

.booking-form {
    background: #f9f9f9;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.booking-form h2 {
    margin-bottom: 1.5rem;
    text-align: center;
}

.booking-form label {
    margin-top: 1rem;
    font-weight: 500;
}

.booking-form input,
.booking-form select,
.booking-form textarea {
    width: 100%;
    padding: 0.6rem;
    margin-top: 0.3rem;
    border-radius: 8px;
    border: 1px solid #ccc;
}
/* Confirmation Box */
.confirmation-box {
    text-align: center;
    padding: 3rem 2rem;
    background: linear-gradient(135deg, #7b2ff7, #00c6ff);
    color: #fff;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: fadeInUp 0.8s ease-out;
}

.confirmation-box h3 {
    font-size: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
}

.confirmation-box p {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 2rem;
}

.confirmation-box button {
    padding: 0.8rem 2rem;
    border: none;
    border-radius: 30px;
    background: #fff;
    color: #7b2ff7;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

.confirmation-box button:hover {
    background: #f1f1f1;
    transform: scale(1.05);
}

/* Animation */
@keyframes fadeInUp {
    0% { 
        opacity: 0; 
        transform: translateY(40px); 
    }
    100% { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.booking-form button {
    margin-top: 1.5rem;
    width: 100%;
    padding: 0.8rem;
    border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, #7b2ff7, #00c6ff);
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
}

.booking-form button:hover {
    opacity: 0.9;
}

.contact-row,
.address-row,
.card-row {
    display: flex;
    gap: 1rem;
}

.contact-field,
.address-field,
.card-field {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.square-ft-inputs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.popup-box {
    text-align: center;
    padding: 2rem;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

/* Price calculation display */
.price-display {
    background: #e8f5e9;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
}

.price-display .price {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2e7d32;
}
</style>

<div class="booking-wrapper">

    <div class="steps">
        <span class="step" id="step1">1) Booking</span>
        <span class="separator">-----------</span>
        <span class="step" id="step2">2) Payment</span>
    </div>

    <div class="slide active" id="booking-slide">
        <div class="booking-container">
            <form class="booking-form" id="bookingForm" method="POST">
                {% csrf_token %}
                <h2>Book {{ service_name }}</h2>

                <label>Service</label>
                <input type="text" name="service_name" value="{{ service_name }}" readonly>

                <div class="contact-row">
                    <div class="contact-field">
                        <label>Contact Number</label>
                        <input type="text" name="contact_number" required>
                    </div>
                    <div class="contact-field">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                </div>

                <label>Address</label>
                <textarea name="address" required></textarea>

                <div class="address-row">
                    <div class="address-field">
                        <label>Pin Code</label>
                        <input type="text" name="pin_code" required>
                    </div>
                    <div class="address-field">
                        <label>State</label>
                        <input type="text" name="state" required>
                    </div>
                    <div class="address-field">
                        <label>City</label>
                        <input type="text" name="city" required>
                    </div>
                </div>

                <label>Total Walls</label>
                <input type="number" name="total_walls" required>

                <div class="square-appointment-row">
                    <div class="square-ft">
                        <label>Square Ft</label>
                        <div class="square-ft-inputs">
                            <input type="number" id="width" name="width" placeholder="Width" required>
                            <span>*</span>
                            <input type="number" id="height" name="height" placeholder="Height" required>
                            <span>=</span>
                            <input type="number" id="total_sqft" name="total_sqft" readonly>
                        </div>
                    </div>
                </div>

                <!-- Price Display -->
                <div class="price-display" id="price-display" style="display: none;">
                    <div>Estimated Price:</div>
                    <div class="price" id="calculated-price">â‚¹0</div>
                    <small>(â‚¹50 per sqft)</small>
                </div>

                <div class="appointment-date">
                    <label>Appointment Date</label>
                    <input type="date" id="appointment_date" name="appointment_date" required>
                </div>

                <button type="button" onclick="saveBooking()">Next â†’ Payment</button>
            </form>
        </div>
    </div>

    <!-- PAYMENT SLIDE -->
    <div class="slide" id="payment-slide">
        <div class="booking-container">
            <form class="booking-form" id="paymentForm">
                {% csrf_token %}
                <h2>Payment</h2>

                <label>Payment Mode</label>
                <select name="payment_mode" id="payment_mode" required>
                    <option value="razorpay">Online Payment</option>
                    <option value="cash">Cash on Service</option>
                </select>

                <label>Amount</label>
                <input type="text" id="booking_amount" name="amount" value="0" readonly>

                <button type="button" onclick="initiatePayment()" id="payment-btn">
                    <span id="payment-btn-text">Proceed to Pay</span>
                    <span id="payment-loader" style="display:none;">Processing...</span>
                </button>
            </form>
        </div>
    </div>

    <div class="slide" id="confirmation-slide">
    <div class="confirmation-box">
        <h3>ðŸŽ‰ Booking Confirmed!</h3>
        <p>
            Your booking for <strong>{{ service_name }}</strong> is successful.<br>
            âœ… Payment received successfully!<br>
            We got the confirmation. Our team will get in touch with you within 24 hrs.
        </p>
        <button onclick="goHome()">Go to Home</button>
    </div>
</div>
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll('.slide');
    
    function showSlide(index) {
        slides.forEach((s, i) => s.classList.toggle('active', i === index));
        currentSlide = index;
        document.getElementById("step1").classList.toggle("active", index === 0);
        document.getElementById("step2").classList.toggle("active", index === 1);
    }

    // Auto sqft and price calculation
    document.getElementById("width").addEventListener("input", calcSqftAndPrice);
    document.getElementById("height").addEventListener("input", calcSqftAndPrice);

    function calcSqftAndPrice() {
        let w = parseFloat(document.getElementById("width").value) || 0;
        let h = parseFloat(document.getElementById("height").value) || 0;
        let sqft = w * h;
        
        // Update square feet
        document.getElementById("total_sqft").value = sqft;
        
        // Calculate price (â‚¹50 per sqft - adjust as needed)
        let pricePerSqft = 50;
        let totalPrice = sqft * pricePerSqft;
        
        // Update price display
        if (sqft > 0) {
            document.getElementById("price-display").style.display = "block";
            document.getElementById("calculated-price").textContent = "â‚¹" + totalPrice;
            document.getElementById("booking_amount").value = totalPrice;
        } else {
            document.getElementById("price-display").style.display = "none";
            document.getElementById("booking_amount").value = 0;
        }
    }

    // Datepicker
    flatpickr("#appointment_date", {
        dateFormat: "d-m-Y",
        minDate: "today"
    });

    // Save Booking â†’ Move to Payment
    function saveBooking() {
        // Validate amount before proceeding
        let amount = document.getElementById('booking_amount').value;
        if (!amount || parseFloat(amount) <= 0) {
            alert('Please enter width and height to calculate the price.');
            return;
        }

        let form = $('#bookingForm')[0];
        let formData = new FormData(form);

        $.ajax({
            url: '/home/save_bookings/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(resp) {
                console.log('Response:', resp);
                
                // Handle different response types
                if (typeof resp === 'string') {
                    try {
                        resp = JSON.parse(resp);
                    } catch (e) {
                        console.error('Invalid JSON response:', resp);
                        // If not JSON, proceed anyway
                        showSlide(1);
                        return;
                    }
                }
                
                if (resp && resp.success) {
                    showSlide(1); // Go to Payment
                } else if (resp && resp.message) {
                    alert("Error: " + resp.message);
                } else {
                    // If no proper response structure, just proceed
                    console.warn('No proper response structure, proceeding anyway');
                    showSlide(1); // Go to Payment
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', xhr.responseText, status, error);
                // For now, proceed even if there's an error (you can remove this later)
                alert("Booking saved locally, proceeding to payment.");
                showSlide(1);
            }
        });
    }

    // PAYMENT FUNCTIONS
    function initiatePayment() {
        const paymentMode = document.getElementById('payment_mode').value;
        
        if (paymentMode === 'cash') {
            // Handle cash on delivery - go directly to confirmation
            showSlide(2);
            return;
        }
        
        if (paymentMode === 'razorpay') {
            startRazorpayPayment();
        }
    }

    function startRazorpayPayment() {
        const amount = document.getElementById('booking_amount').value;
        
        // Validate amount
        if (!amount || amount.trim() === '' || parseFloat(amount) <= 0) {
            alert('Invalid amount. Please check the booking amount.');
            return;
        }
        
        console.log('Payment amount:', amount);
        
        // Show loading state
        showPaymentLoading(true);
        
        // Create Razorpay order
        $.ajax({
            url: '/create_razorpay_order/',
            type: 'POST',
            data: {
                'amount': amount,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                console.log('Razorpay order response:', response);
                showPaymentLoading(false);
                if (response.success) {
                    openRazorpayCheckout(response);
                } else {
                    alert('Error creating payment order: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Order creation error:', xhr.responseText);
                showPaymentLoading(false);
                alert('Something went wrong while creating payment order: ' + error);
            }
        });
    }

    function openRazorpayCheckout(orderData) {
        // Get customer details from booking form
        const contactNumber = document.querySelector('input[name="contact_number"]').value;
        const email = document.querySelector('input[name="email"]').value;
        const customerName = "Customer";

        const options = {
            "key": orderData.key_id,
            "amount": orderData.amount,
            "currency": orderData.currency,
            "name": "Home Services", // Replace with your business name
            "description": "Service Booking Payment",
            "order_id": orderData.order_id,
            "handler": function (response) {
                verifyPayment(response);
            },
            "prefill": {
                "name": customerName,
                "email": email,
                "contact": contactNumber
            },
            "notes": {
                "service": "{{ service_name }}"
            },
            "theme": {
                "color": "#7b2ff7"
            },
            "modal": {
                "ondismiss": function(){
                    showPaymentLoading(false);
                    alert('Payment was cancelled');
                }
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
    }

    function verifyPayment(response) {
        showPaymentLoading(true);
        
        $.ajax({
            url: '/verify_razorpay_payment/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                'razorpay_order_id': response.razorpay_order_id,
                'razorpay_payment_id': response.razorpay_payment_id,
                'razorpay_signature': response.razorpay_signature
            }),
            headers: {
                "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(verifyResponse) {
                showPaymentLoading(false);
                if (verifyResponse.success) {
                    // Payment successful - go to confirmation
                    showSlide(2);
                } else {
                    alert('Payment verification failed: ' + verifyResponse.error);
                }
            },
            error: function() {
                showPaymentLoading(false);
                alert('Error verifying payment!');
            }
        });
    }

    function showPaymentLoading(show) {
        if (show) {
            document.getElementById('payment-btn-text').style.display = 'none';
            document.getElementById('payment-loader').style.display = 'inline';
            document.getElementById('payment-btn').disabled = true;
        } else {
            document.getElementById('payment-btn-text').style.display = 'inline';
            document.getElementById('payment-loader').style.display = 'none';
            document.getElementById('payment-btn').disabled = false;
        }
    }

    function goHome() {
        window.location.href = "{% url 'home' %}";
    }
</script>

{% endblock %}