{% extends 'base.html' %}
{% load static %}

{% block title %}Customer Signup - Painting{% endblock %}

{% block content %}
<div class="auth-container">
  <div class="auth-box">
    <h1>Customer Registration üè†</h1>
    <p class="subtitle">Register and book painting services</p>

    <form id="customerSignupForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}

       <!-- Full Name -->
  <div class="input-group">
    <label for="customer_full_name">Full Name of Customer</label>
    <input type="text" id="customer_full_name" name="customer_full_name" required>
  </div>

  <!-- Mobile -->
  <div class="input-group">
    <label for="mobile">Mobile Number</label>
    <input type="text" id="mobile" name="mobile" required>
  </div>

  <!-- Email -->
  <div class="input-group">
    <label for="email">Email Address (if any)</label>
    <input type="text" id="email" name="email">
  </div>

  <!-- Password -->
  <div class="input-group">
    <label for="customer_password">Create Password</label>
    <input type="password" id="customer_password" name="customer_password" required>
  </div>

  <button type="button" id="submitButton" class="btn" onclick="onClickCustomerSignUp()">Register</button>
  <p class="switch-text">Already have an account? <a href="{% url 'accounts:login' %}">Login</a></p>
</form>
  </div>
</div>

<!-- OTP Modal -->
<div id="otpModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:300px; text-align:center;">
    <h3>Email Verification</h3>
    <p>Please enter the OTP sent to your email</p>
    <input type="text" id="otpInput" maxlength="6" placeholder="Enter OTP">
    <br><br>
    <button type="button" onclick="verifyOTP()">Verify</button>
    <button type="button" onclick="closeOtpModal()">Cancel</button>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script>
  function onClickCustomerSignUp() {
    var form = $('#customerSignupForm')[0];
    var formData = new FormData(form);
    var email = $('#email').val();
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;  // basic validation
    if (!emailRegex.test(email)) {
        alert("Please enter a valid email address (must contain @ and domain)");
        return; // stop submission
    }

    $.ajax({
        url: '/accounts/save_customer_signup/',  // add this endpoint in urls.py + views.py
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if(response.success) {
                alert(response.message);
                $('#customer_full_name').val('');
                $('#mobile').val('');
                $('#email').val('');
                $('#customer_password').val('');

                window.location.href = '/accounts/login/';
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error:', xhr.responseText);
            alert('Something went wrong!');
        }
    });
}
</script>



<script>
    {% comment %} email verification otp  {% endcomment %}
    var currentCustomerId = null;

function onClickCustomerSignUp() {
    var form = $('#customerSignupForm')[0];
    var formData = new FormData(form);
    var email = $('#email').val();

    if (email) {
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert("Please enter a valid email address (must contain @ and domain)");
            return;
        }
    }

    $.ajax({
        url: '/accounts/save_customer_signup/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if(response.success) {
                alert(response.message);
                currentCustomerId = response.customer_id;
                $('#otpModal').css("display", "flex"); // ‚úÖ show modal
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            console.error('Error:', xhr.responseText);
            alert('Something went wrong!');
        }
    });
}

function verifyOTP() {
    var otp = $('#otpInput').val();

    $.ajax({
        url: '/accounts/verify_customer_otp/',
        type: 'POST',
        data: {customer_id: currentCustomerId, otp: otp},
        success: function(response) {
            if(response.success) {
                alert(response.message);
                closeOtpModal(); // ‚úÖ hide modal
                window.location.href = '/accounts/login/';
            } else {
                alert('Error: ' + response.error);
            }
        }
    });
}

function closeOtpModal() {
    $('#otpModal').hide();
}

</script>
{% endblock %}
